<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hiyoi.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="hiyoi">
<meta property="og:url" content="https://hiyoi.com/index.html">
<meta property="og:site_name" content="hiyoi">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="hiyoi">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://hiyoi.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>hiyoi</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-110993942-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-110993942-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">hiyoi</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/hiyoi" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hiyoi.com/2018/07/28/2018-07-28-Nginx_Log%E6%97%A5%E5%BF%97%E7%BB%9F%E8%AE%A1%E5%88%86%E6%9E%90%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hiyoi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hiyoi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/07/28/2018-07-28-Nginx_Log%E6%97%A5%E5%BF%97%E7%BB%9F%E8%AE%A1%E5%88%86%E6%9E%90%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">Nginx Log日志统计分析常用命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-07-28 23:25:00" itemprop="dateCreated datePublished" datetime="2018-07-28T23:25:00+08:00">2018-07-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-11-08 16:19:10" itemprop="dateModified" datetime="2019-11-08T16:19:10+08:00">2019-11-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/" itemprop="url" rel="index"><span itemprop="name">默认分类</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>IP相关统计</strong></p>
<p>统计IP访问量（独立ip访问数量）<br>    awk ‘{print $1}’ access.log | sort -n | uniq | wc -l<br>查看某一时间段的IP访问量(4-5点)</p>
<pre><code>grep &quot;07/Apr/2017:0[4-5]&quot; access.log | awk &apos;{print $1}&apos; | sort | uniq -c| sort -nr | wc -l  </code></pre><p>查看访问最频繁的前100个IP</p>
<pre><code>awk &apos;{print $1}&apos; access.log | sort -n |uniq -c | sort -rn | head -n 100</code></pre><p>查看访问100次以上的IP</p>
<pre><code>awk &apos;{print $1}&apos; access.log | sort -n |uniq -c |awk &apos;{if($1 &gt;100) print $0}&apos;|sort -rn</code></pre><p>查询某个IP的详细访问情况,按访问频率排序</p>
<pre><code>grep &apos;127.0.01&apos; access.log |awk &apos;{print $7}&apos;|sort |uniq -c |sort -rn |head -n 100</code></pre><p><strong>页面访问统计</strong></p>
<p>查看访问最频的页面(TOP100)</p>
<pre><code>awk &apos;{print $7}&apos; access.log | sort |uniq -c | sort -rn | head -n 100</code></pre><p>查看访问最频的页面([排除php页面])(TOP100)</p>
<pre><code>grep -v &quot;.php&quot;  access.log | awk &apos;{print $7}&apos; | sort |uniq -c | sort -rn | head -n 100 </code></pre><p>查看页面访问次数超过100次的页面</p>
<pre><code>cat access.log | cut -d &apos; &apos; -f 7 | sort |uniq -c | awk &apos;{if ($1 &gt; 100) print $0}&apos; | less</code></pre><p>查看最近1000条记录，访问量最高的页面</p>
<pre><code>tail -1000 access.log |awk &apos;{print $7}&apos;|sort|uniq -c|sort -nr|less</code></pre><p><strong>每秒请求量统计</strong></p>
<p>统计每秒的请求数,top100的时间点(精确到秒)</p>
<pre><code>awk &apos;{print $4}&apos; access.log |cut -c 14-21|sort|uniq -c|sort -nr|head -n 100</code></pre><p><strong>每分钟请求量统计</strong></p>
<p>统计每分钟的请求数,top100的时间点(精确到分钟)</p>
<pre><code>awk &apos;{print $4}&apos; access.log |cut -c 14-18|sort|uniq -c|sort -nr|head -n 100</code></pre><p><strong>每小时请求量统计</strong></p>
<p>统计每小时的请求数,top100的时间点(精确到小时)</p>
<pre><code>awk &apos;{print $4}&apos; access.log |cut -c 14-15|sort|uniq -c|sort -nr|head -n 100</code></pre><p><strong>性能分析</strong></p>
<p>在nginx log中最后一个字段加入$request_time</p>
<p>列出传输时间超过 3 秒的页面，显示前20条</p>
<pre><code>cat access.log|awk &apos;($NF &gt; 3){print $7}&apos;|sort -n|uniq -c|sort -nr|head -20</code></pre><p><strong>蜘蛛抓取统计</strong></p>
<p>统计蜘蛛抓取次数</p>
<pre><code>grep &apos;Baiduspider&apos; access.log |wc -l</code></pre><p>统计蜘蛛抓取404的次数</p>
<pre><code>grep &apos;Baiduspider&apos; access.log |grep &apos;404&apos; | wc -l</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hiyoi.com/2018/07/09/2018-07-09-python+flask+mongodb_%E6%90%AD%E5%BB%BA%E6%BC%AB%E7%94%BB%E7%AB%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hiyoi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hiyoi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/07/09/2018-07-09-python+flask+mongodb_%E6%90%AD%E5%BB%BA%E6%BC%AB%E7%94%BB%E7%AB%99/" class="post-title-link" itemprop="url">python+flask+mongodb 搭建漫画站</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-07-09 11:26:00" itemprop="dateCreated datePublished" datetime="2018-07-09T11:26:00+08:00">2018-07-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-02 13:25:47" itemprop="dateModified" datetime="2019-10-02T13:25:47+08:00">2019-10-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/" itemprop="url" rel="index"><span itemprop="name">默认分类</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近想玩玩mongodb，虽然SQL数据库还是占据主导地位，但NoSQL数据库还是有一定优势的，比如在QPS上NoSQL性能就远远大于SQL。</p>
<h3 id="传送门"><a href="#传送门" class="headerlink" title="传送门"></a><a href="https://www.kumaodm.com" target="_blank" rel="noopener">传送门</a></h3><p><img src="https://i.loli.net/2019/10/02/36mEjqosC7GOUT9.jpg" alt="截图"></p>
<p>主体用了 <a href="http://flask.pocoo.org/" target="_blank" rel="noopener">flask</a> + <a href="https://www.mongodb.com/" target="_blank" rel="noopener">mongodb</a></p>
<p>部署用了 <a href="http://nginx.org/" target="_blank" rel="noopener">nginx</a> + <a href="http://gunicorn.org/" target="_blank" rel="noopener">gunicorn</a></p>
<p>前端用了国人开发的 <a href="https://www.mdui.org/" target="_blank" rel="noopener">mdui</a>，google material design设计的css库</p>
<p>mongodb效率还是蛮高的，python下似乎只有<a href="http://api.mongodb.com/python/current/" target="_blank" rel="noopener">pymongo</a>这个库可以用，其实也够用了。</p>
<h3 id="主要遇到的问题"><a href="#主要遇到的问题" class="headerlink" title="主要遇到的问题:"></a>主要遇到的问题:</h3><p>mongodb 在 <code>sort()</code> 排序上如果数据量太大就会报内存不够的错误，默认的限制只有32M大小。</p>
<pre><code>pymongo.errors.OperationFailure: Executor error during find command :: caused by :: Sort operation used more than the maximum 33554432 bytes of RAM. Add an index, or specify a smaller limit.</code></pre><p>解决办法就是给数据集合创建索引</p>
<pre><code>db.collection.createIndex(keys, options)</code></pre><p><code>collection</code>为需要创建索引的集合, <code>keys</code>为需要创建的字段， <code>options</code>可选<code>-1</code>表示按降序来排列,<code>1</code>表示升序排列</p>
<p>创建完毕后可用以下命令查看创建的结果</p>
<pre><code>db.collection.getIndexes()</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hiyoi.com/2018/01/03/2018-01-03-python_-_%E4%B8%80%E5%8F%AAasync%E7%88%AC%E8%99%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hiyoi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hiyoi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/01/03/2018-01-03-python_-_%E4%B8%80%E5%8F%AAasync%E7%88%AC%E8%99%AB/" class="post-title-link" itemprop="url">python - 一只async爬虫</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-01-03 17:22:00" itemprop="dateCreated datePublished" datetime="2018-01-03T17:22:00+08:00">2018-01-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-02 13:31:50" itemprop="dateModified" datetime="2019-10-02T13:31:50+08:00">2019-10-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/" itemprop="url" rel="index"><span itemprop="name">默认分类</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近有个业务场景:<br>需要抓出<a href="https://coinmarketcap.com/all/views/all/" target="_blank" rel="noopener">coinmarketcap</a>下的所有虚拟币链接里面的官网地址</p>
<p><img src="https://i.loli.net/2019/10/02/XS5Y1yMOoQFfptn.jpg" alt="coin"><br><img src="https://i.loli.net/2019/10/02/4L3c5RsTXfDCNIY.jpg" alt="website"></p>
<p>比如 <a href="https://coinmarketcap.com/currencies/bitcoin/" target="_blank" rel="noopener">bitcoin</a> 里面的 <a href="https://bitcoin.org/en/" target="_blank" rel="noopener">website</a> 和 <a href="https://www.bitcoin.com/" target="_blank" rel="noopener">website2</a></p>
<p>这样算起来大概有1300多个url，如果直接采用顺序抓取，那io瓶颈会十分明显</p>
<p>使用requests来爬取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"># coding: utf-8</span><br><span class="line">from __future__ import print_function</span><br><span class="line">import requests</span><br><span class="line">from bs4 import BeautifulSoup</span><br><span class="line">from bs4 import SoupStrainer</span><br><span class="line">import csv</span><br><span class="line">import os</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Spider(object):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.session = requests.session()</span><br><span class="line">        self.targetUrl = None</span><br><span class="line">        self.headers = &#123;</span><br><span class="line">            &apos;User-Agent&apos;: &apos;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36&apos;,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    def getResponse(self, url=None):</span><br><span class="line">        try:</span><br><span class="line">            self.session.headers = self.headers</span><br><span class="line">            self.targetUrl = url</span><br><span class="line">            resp = self.session.get(self.targetUrl, headers=self.headers)</span><br><span class="line">            return resp</span><br><span class="line">        except Exception as e:</span><br><span class="line">            print(e)</span><br><span class="line"></span><br><span class="line">    def getCoinList(self):</span><br><span class="line">        url = &apos;https://files.coinmarketcap.com/generated/search/quick_search.json&apos;</span><br><span class="line">        try:</span><br><span class="line">            resp = self.getResponse(url)</span><br><span class="line">        except Exception as e:</span><br><span class="line">            print(e)</span><br><span class="line">        return resp.json()</span><br><span class="line"></span><br><span class="line">    def getWebSite(self, slug):</span><br><span class="line">        url = &apos;https://coinmarketcap.com/currencies/%s/&apos; % slug</span><br><span class="line">        try:</span><br><span class="line">            html = self.getResponse(url).content</span><br><span class="line">            only_a_title = SoupStrainer(&apos;ul&apos;, attrs=&#123;&apos;class&apos;: &apos;list-unstyled&apos;&#125;)</span><br><span class="line">            soup = BeautifulSoup(html, &quot;lxml&quot;, parse_only=only_a_title)</span><br><span class="line">            links = soup.select(&apos;span[title=&quot;Website&quot;] ~ a&apos;)</span><br><span class="line">            r = []</span><br><span class="line">            for x in links:</span><br><span class="line">                r.append(x[&apos;href&apos;])</span><br><span class="line">            return &apos; , &apos;.join(r)</span><br><span class="line">        except Exception as e:</span><br><span class="line">            print(e)</span><br><span class="line">            return &apos;&apos;</span><br><span class="line"></span><br><span class="line">    def dumpCSV(self):</span><br><span class="line">        path = os.path.join(os.path.split(os.path.realpath(__file__))[0], &apos;coin.csv&apos;)</span><br><span class="line">        results = self.getCoinList()</span><br><span class="line">        with open(path, &apos;w&apos;) as f:</span><br><span class="line">            fieldnames = [&apos;rank&apos;, &apos;name&apos;, &apos;symbol&apos;, &apos;website&apos;]</span><br><span class="line">            wr = csv.DictWriter(f, fieldnames=fieldnames)</span><br><span class="line">            wr.writeheader()</span><br><span class="line">            i = 1</span><br><span class="line">            for x in results:</span><br><span class="line">                print(i, x[&apos;name&apos;])</span><br><span class="line">                websites = self.getWebSite(x[&apos;slug&apos;])</span><br><span class="line">                wr.writerow(&#123;&apos;name&apos;: x[&apos;name&apos;], &apos;symbol&apos;: x[&apos;symbol&apos;], &apos;rank&apos;: x[&apos;rank&apos;], &apos;website&apos;: websites&#125;)</span><br><span class="line">                i += 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    spider = Spider()</span><br><span class="line">    start = time.time()</span><br><span class="line">    spider.dumpCSV()</span><br><span class="line">    print(time.time() - start)</span><br></pre></td></tr></table></figure>
<p>执行下来，大概需要830s，也就是13分钟。<br>这样的速度实在太慢，改用asyncio+aiohttp，性能暴增</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"># coding:utf-8</span><br><span class="line">import aiohttp</span><br><span class="line">import asyncio</span><br><span class="line">from bs4 import BeautifulSoup</span><br><span class="line">from bs4 import SoupStrainer</span><br><span class="line">import json</span><br><span class="line">import csv</span><br><span class="line">import os</span><br><span class="line">import time</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line"># Linux下使用uvloop代替自带的loop</span><br><span class="line">if sys.platform == &apos;linux&apos;:</span><br><span class="line">    import uvloop</span><br><span class="line">    asyncio.set_event_loop_policy(uvloop.EventLoopPolicy())</span><br><span class="line"></span><br><span class="line"># winddows下使用IOCP</span><br><span class="line">if sys.platform == &apos;win32&apos;:</span><br><span class="line">    loop = asyncio.ProactorEventLoop()</span><br><span class="line">    asyncio.set_event_loop(loop)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">async def getWeb(slug, sem):</span><br><span class="line">    headers = &#123;&apos;User-Agent&apos;: &apos;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36&apos;&#125;</span><br><span class="line">    url = &apos;https://coinmarketcap.com/currencies/&#123;&#125;/&apos;.format(slug)</span><br><span class="line">    try:</span><br><span class="line">        with await sem:</span><br><span class="line">            async with aiohttp.ClientSession() as session:</span><br><span class="line">                async with session.get(url, headers=headers, timeout=10) as resp:</span><br><span class="line">                    return await resp.text()</span><br><span class="line">    except Exception as e:</span><br><span class="line">        print(e)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 先抓取列表</span><br><span class="line">async def getList():</span><br><span class="line">    global result</span><br><span class="line">    url = &apos;https://files.coinmarketcap.com/generated/search/quick_search.json&apos;</span><br><span class="line">    async with aiohttp.ClientSession() as session:</span><br><span class="line">        async with session.get(url) as resp:</span><br><span class="line">            result = await resp.text()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">async def main(slug, sem):</span><br><span class="line">    global link</span><br><span class="line">    # 因为数量不是很大,这里直接用字典来缓存结果</span><br><span class="line">    # 数量多的话可以使用redis来做缓存</span><br><span class="line">    link = &#123;&#125;</span><br><span class="line">    try:</span><br><span class="line">        html = await getWeb(slug, sem)</span><br><span class="line">        # 使用beautifulsoup解析文档</span><br><span class="line">        only_a_title = SoupStrainer(&apos;ul&apos;, attrs=&#123;&apos;class&apos;: &apos;list-unstyled&apos;&#125;)</span><br><span class="line">        soup = BeautifulSoup(html, &quot;lxml&quot;, parse_only=only_a_title)</span><br><span class="line">        links = soup.select(&apos;span[title=&quot;Website&quot;] ~ a&apos;)</span><br><span class="line">        r = []</span><br><span class="line">        if links is not None:</span><br><span class="line">            for x in links:</span><br><span class="line">                r.append(x[&apos;href&apos;])</span><br><span class="line">            link[slug] = &apos;,&apos;.join(r)</span><br><span class="line">            print(r)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        print(e)</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    start = time.time()</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(getList())</span><br><span class="line"></span><br><span class="line">    # 控制并发数</span><br><span class="line">    sem = asyncio.Semaphore(200)</span><br><span class="line">    tasks = [main(x[&apos;slug&apos;], sem) for x in json.loads(result)]</span><br><span class="line"></span><br><span class="line">    loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">except Exception as e:</span><br><span class="line">    print(e)</span><br><span class="line"></span><br><span class="line">path = os.path.join(os.path.split(os.path.realpath(__file__))[0], &apos;coin.csv&apos;)</span><br><span class="line"></span><br><span class="line"># 把抓取结果写到csv文件里面</span><br><span class="line">with open(path, &apos;w&apos;) as f:</span><br><span class="line">    fieldnames = [&apos;rank&apos;, &apos;name&apos;, &apos;symbol&apos;, &apos;website&apos;]</span><br><span class="line">    wr = csv.DictWriter(f, fieldnames=fieldnames)</span><br><span class="line">    wr.writeheader()</span><br><span class="line">    for x in json.loads(result):</span><br><span class="line">        print(x[&apos;rank&apos;], x[&apos;name&apos;])</span><br><span class="line">        s = x[&apos;slug&apos;]</span><br><span class="line">        if s in link:</span><br><span class="line">            site = link[s]</span><br><span class="line">        else:</span><br><span class="line">            site = &apos;&apos;</span><br><span class="line">        wr.writerow(&#123;&apos;name&apos;: x[&apos;name&apos;], &apos;symbol&apos;: x[&apos;symbol&apos;], &apos;rank&apos;: x[&apos;rank&apos;], &apos;website&apos;: site&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(time.time() - start)</span><br></pre></td></tr></table></figure>
<p>执行下来只要不到1分钟，性能增加了10倍不止<br>带宽利用率也达到了最大化<br><img src="https://i.loli.net/2019/10/02/Ef6ikvj9oZGB4nq.jpg" alt="band"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hiyoi.com/2017/12/22/2017-12-22-python_-_%E4%B8%80%E4%B8%AAasyncio%E7%9A%84%E4%BE%8B%E5%AD%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hiyoi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hiyoi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/12/22/2017-12-22-python_-_%E4%B8%80%E4%B8%AAasyncio%E7%9A%84%E4%BE%8B%E5%AD%90/" class="post-title-link" itemprop="url">python - 一个asyncio的例子</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-12-22 13:49:00" itemprop="dateCreated datePublished" datetime="2017-12-22T13:49:00+08:00">2017-12-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-01-03 17:23:39" itemprop="dateModified" datetime="2018-01-03T17:23:39+08:00">2018-01-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/" itemprop="url" rel="index"><span itemprop="name">默认分类</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>asyncio已经在python3的标准库中，是未来的趋势。<br><a href="https://docs.python.org/3/library/asyncio.html" target="_blank" rel="noopener">官方文档</a></p>
<p>直接上代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">import asyncio</span><br><span class="line">import time</span><br><span class="line"> </span><br><span class="line">now = lambda: time.time()</span><br><span class="line"> </span><br><span class="line">#模拟异步任务</span><br><span class="line">async def do_some_work(x):</span><br><span class="line">    print(&apos;Waiting: &apos;, x)</span><br><span class="line">    await asyncio.sleep(x)</span><br><span class="line">    return &apos;Done after &#123;&#125;s&apos;.format(x)</span><br><span class="line"> </span><br><span class="line">start = now()</span><br><span class="line"> </span><br><span class="line">coroutine1 = do_some_work(4)</span><br><span class="line">coroutine2 = do_some_work(4)</span><br><span class="line">coroutine3 = do_some_work(3)</span><br><span class="line"></span><br><span class="line">#起三个任务</span><br><span class="line">tasks = [</span><br><span class="line">    asyncio.ensure_future(coroutine1),</span><br><span class="line">    asyncio.ensure_future(coroutine2),</span><br><span class="line">    asyncio.ensure_future(coroutine3)</span><br><span class="line">]</span><br><span class="line"> </span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line"> </span><br><span class="line">for task in tasks:</span><br><span class="line">    print(&apos;Task ret: &apos;, task.result())</span><br><span class="line"> </span><br><span class="line">print(&apos;TIME: &apos;, now() - start)</span><br></pre></td></tr></table></figure>
<p>输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Waiting:  4</span><br><span class="line">Waiting:  4</span><br><span class="line">Waiting:  3</span><br><span class="line">Task ret:  Done after 4s</span><br><span class="line">Task ret:  Done after 4s</span><br><span class="line">Task ret:  Done after 3s</span><br><span class="line">TIME:  4.003447771072388</span><br></pre></td></tr></table></figure>

<p>三个任务，每个任务分别需要4秒，4秒，3秒，当任务遇到<strong>await</strong>关键字时，就会挂起，然后执行其他任务，总的消耗时间大致上会接近4秒(取决于最长消耗时间的任务)，实际上会额外消耗一点时间用于任务切换，但是所有任务均在一个线程内，这个开销基本上可以忽略不计。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hiyoi.com/2017/12/20/2017-12-20-python_-_google_oauth2_%E7%99%BB%E9%99%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hiyoi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hiyoi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/12/20/2017-12-20-python_-_google_oauth2_%E7%99%BB%E9%99%86/" class="post-title-link" itemprop="url">python - google oauth2 登陆</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-12-20 08:59:00" itemprop="dateCreated datePublished" datetime="2017-12-20T08:59:00+08:00">2017-12-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-02 13:27:43" itemprop="dateModified" datetime="2019-10-02T13:27:43+08:00">2019-10-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/" itemprop="url" rel="index"><span itemprop="name">默认分类</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近业务用上了google oauth2登陆,<a href="https://developers.google.com/api-client-library/python/auth/web-app" target="_blank" rel="noopener">google文档</a>写的很详细,在python flask很容易就能实现oauth2登陆.<br>oauth2的原理一张图就能概括:<br><img src="https://i.loli.net/2019/10/02/t7Cm8rdiDKfq5FA.jpg" alt="webflow.png"></p>
<p>需要用到的库:<br>The Google APIs Client Library for Python:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install --upgrade google-api-python-client</span><br></pre></td></tr></table></figure>
<p>The google-auth, google-auth-oauthlib, and google-auth-httplib2 for user authorization.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install --upgrade google-auth google-auth-oauthlib google-auth-httplib2</span><br></pre></td></tr></table></figure>
<p>下面贴一下关键代码(省略了很多无关的):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">#登陆界面</span><br><span class="line">@app.route(&apos;/index&apos;)</span><br><span class="line">def login_index():</span><br><span class="line">    return render_template(&apos;login.html&apos;)</span><br><span class="line"></span><br><span class="line">#登陆</span><br><span class="line">@app.route(&apos;/login&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</span><br><span class="line">def login():</span><br><span class="line">    if &apos;credentials&apos; not in session:</span><br><span class="line">        #首先要获取凭据，调用授权方法</span><br><span class="line">        return redirect(url_for(&apos;authorize&apos;))</span><br><span class="line"></span><br><span class="line">    credentials = google.oauth2.credentials.Credentials(</span><br><span class="line">        **session[&apos;credentials&apos;])</span><br><span class="line"></span><br><span class="line">    #到这里就授权成功，可以通过authed_session来调用google api</span><br><span class="line">    authed_session = AuthorizedSession(credentials)</span><br><span class="line">  </span><br><span class="line">    #调用google api 获取授权用户的信息</span><br><span class="line">    response = authed_session.get(&apos;https://www.googleapis.com/userinfo/v2/me&apos;)</span><br><span class="line">    user = json.loads(response.text)</span><br><span class="line">    #用户账号存入session</span><br><span class="line">    session[&apos;user&apos;] = user[&apos;email&apos;]</span><br><span class="line">    #返回登陆成功页面   </span><br><span class="line">    return render_template(&apos;success.html&apos;)</span><br><span class="line"></span><br><span class="line">#注销</span><br><span class="line">@app.route(&apos;/logout&apos;)</span><br><span class="line">def logout():</span><br><span class="line">    if &apos;credentials&apos; not in session:</span><br><span class="line">        return redirect(url_for(&apos;login_index&apos;))</span><br><span class="line">    credentials = google.oauth2.credentials.Credentials(</span><br><span class="line">        **session[&apos;credentials&apos;])</span><br><span class="line">    try:</span><br><span class="line">        # 注销凭据需要传入一个凭据token参数然后post到相应的api地址</span><br><span class="line">        revoke = requests.post(&apos;https://accounts.google.com/o/oauth2/revoke&apos;,</span><br><span class="line">                               params=&#123;&apos;token&apos;: credentials.token&#125;,</span><br><span class="line">                               headers=&#123;&apos;content-type&apos;: &apos;application/x-www-form-urlencoded&apos;&#125;)</span><br><span class="line"></span><br><span class="line">        status_code = getattr(revoke, &apos;status_code&apos;)</span><br><span class="line">        #注销成功后删除用户登陆session</span><br><span class="line">        del session[&apos;user&apos;]</span><br><span class="line">        if status_code == 200:</span><br><span class="line">            #删除session中的凭据</span><br><span class="line">            del session[&apos;credentials&apos;]</span><br><span class="line">            flash(&apos;Logout successful!&apos;, &apos;success&apos;)</span><br><span class="line">            return render_template(&apos;login.html&apos;)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        app.logger.info(e)</span><br><span class="line"></span><br><span class="line">#授权</span><br><span class="line">@app.route(&apos;/authorize&apos;)</span><br><span class="line">def authorize():</span><br><span class="line">    #这里需要一个在google cloud 平台申请的一个凭据密钥，client_secret.json</span><br><span class="line">    #需要到https://console.cloud.google.com/apis/credentials申请</span><br><span class="line">    CLIENT_SECRETS_FILE = app.config[&apos;CLIENT_SECRETS_FILE&apos;]</span><br><span class="line">    #需要申请的权限范围</span><br><span class="line">    SCOPES = app.config[&apos;SCOPES&apos;]</span><br><span class="line">    #回调地址</span><br><span class="line">    REDIRECT_URI = app.config[&apos;REDIRECT_URI&apos;]</span><br><span class="line">    flow = google_auth_oauthlib.flow.Flow.from_client_secrets_file(</span><br><span class="line">        CLIENT_SECRETS_FILE, scopes=SCOPES)</span><br><span class="line"></span><br><span class="line">    flow.redirect_uri = REDIRECT_URI</span><br><span class="line">    authorization_url, state = flow.authorization_url(</span><br><span class="line">        access_type=&apos;offline&apos;,</span><br><span class="line">        include_granted_scopes=&apos;true&apos;)</span><br><span class="line">    session[&apos;state&apos;] = state</span><br><span class="line">    return redirect(authorization_url)</span><br><span class="line"></span><br><span class="line">#授权成功后的回调函数</span><br><span class="line">@app.route(&apos;/oauth2callback&apos;)</span><br><span class="line">def oauth2callback():</span><br><span class="line">    try:</span><br><span class="line">        state = session[&apos;state&apos;]</span><br><span class="line">        CLIENT_SECRETS_FILE = app.config[&apos;CLIENT_SECRETS_FILE&apos;]</span><br><span class="line">        SCOPES = app.config[&apos;SCOPES&apos;]</span><br><span class="line">        REDIRECT_URI = app.config[&apos;REDIRECT_URI&apos;]</span><br><span class="line">        flow = google_auth_oauthlib.flow.Flow.from_client_secrets_file(</span><br><span class="line">            CLIENT_SECRETS_FILE, scopes=SCOPES, state=state)</span><br><span class="line">        flow.redirect_uri = REDIRECT_URI</span><br><span class="line">        authorization_response = request.url</span><br><span class="line">        #获取授权token</span><br><span class="line">        flow.fetch_token(authorization_response=authorization_response)</span><br><span class="line">        credentials = flow.credentials</span><br><span class="line">        #存储凭据到session</span><br><span class="line">        session[&apos;credentials&apos;] = credentials_to_dict(credentials)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        if &apos;credentials&apos; in session:</span><br><span class="line">            del session[&apos;credentials&apos;]</span><br><span class="line">        app.logger.info(e)</span><br><span class="line">        return redirect(url_for(&apos;login_index&apos;))</span><br><span class="line">    return redirect(url_for(&apos;login&apos;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def credentials_to_dict(credentials):</span><br><span class="line">    return &#123;&apos;token&apos;: credentials.token,</span><br><span class="line">            &apos;refresh_token&apos;: credentials.refresh_token,</span><br><span class="line">            &apos;token_uri&apos;: credentials.token_uri,</span><br><span class="line">            &apos;client_id&apos;: credentials.client_id,</span><br><span class="line">            &apos;client_secret&apos;: credentials.client_secret,</span><br><span class="line">            &apos;scopes&apos;: credentials.scopes&#125;</span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hiyoi.com/2017/10/17/2017-10-17-gunicorn_%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hiyoi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hiyoi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/10/17/2017-10-17-gunicorn_%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC/" class="post-title-link" itemprop="url">gunicorn 启动脚本</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-10-17 16:42:00" itemprop="dateCreated datePublished" datetime="2017-10-17T16:42:00+08:00">2017-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2017-12-08 23:10:01" itemprop="dateModified" datetime="2017-12-08T23:10:01+08:00">2017-12-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/" itemprop="url" rel="index"><span itemprop="name">默认分类</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="http://gunicorn.org/" target="_blank" rel="noopener">gunicorn</a> 是python web app比较好用的wsgi,下面是一段平时快速启动的shell script。<br>把代码保存成 <code>gunicorn.sh</code> ,添加执行权限 <code>sudo chmod +x gunicorn.sh</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#解释下几个参数:</span><br><span class="line"># -w 设置工作者数，推荐为cpu核心数*2+1</span><br><span class="line"># --reload app代码更新自动重装</span><br><span class="line"># -u 启动用户</span><br><span class="line"># --log-file 日志输出目录</span><br><span class="line"># -k 使用其他异步模块启动如gevent</span><br><span class="line"># -D 作为deamon进程启动</span><br><span class="line">P=5000</span><br><span class="line">worker=3</span><br><span class="line">host=&quot;127.0.0.1&quot;</span><br><span class="line">case &quot;$@&quot; in</span><br><span class="line">  start)</span><br><span class="line">  gunicorn -b $host:$P -w $worker --reload -u root --log-file /var/log/gunicorn/gunicorn.log -k gevent -D app:app</span><br><span class="line">  ;;</span><br><span class="line">  stop)</span><br><span class="line">  kill -9 `ps aux|grep gunicorn|grep $name|awk &apos;&#123;print $2&#125;&apos;|xargs`</span><br><span class="line">  ;;</span><br><span class="line">  status)</span><br><span class="line">  pids=$(ps aux|grep gunicorn|grep $name)</span><br><span class="line">  echo &quot;$pids&quot;</span><br><span class="line">  ;;</span><br><span class="line">  restart)</span><br><span class="line">  kill -9 `ps aux|grep gunicorn|grep $name|awk &apos;&#123;print $2&#125;&apos;|xargs`</span><br><span class="line">  sleep 1</span><br><span class="line">  gunicorn -b $host:$P -w $worker --reload -u root --log-file /var/log/gunicorn/gunicorn.log -k gevent -D app:app</span><br><span class="line">  ;;</span><br><span class="line">  reload)</span><br><span class="line">  ps aux |grep gunicorn |grep $name | awk &apos;&#123;print $2&#125;&apos;|xargs kill -HUP</span><br><span class="line">  ;;</span><br><span class="line">  *)</span><br><span class="line">  echo &apos;unknown arguments args(start|stop|status|restart|reload)&apos;</span><br><span class="line">  exit 1</span><br><span class="line">  ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<p>把<code>gunicorn.sh</code>放到wsgi启动程序的目录，例子中wsgi程序是app.py<br>接着启动只需<br><code>gunicorn.sh start</code><br>停止<br><code>gunicorn.sh stop</code><br>查看进程<br><code>gunicorn.sh status</code><br>重载<br><code>gunicorn.sh reload</code><br>重启<br><code>gunicorn.sh restart</code></p>
<p>用起来有是不是有种nginx的感觉:) ,更多<a href="http://docs.gunicorn.org/en/stable/settings.html" target="_blank" rel="noopener">gunicorn相关设置</a>可以到官网文档查看</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hiyoi.com/2017/09/22/2017-09-22-shadowsocks%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hiyoi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hiyoi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/09/22/2017-09-22-shadowsocks%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">shadowsocks安装配置优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-09-22 16:19:00" itemprop="dateCreated datePublished" datetime="2017-09-22T16:19:00+08:00">2017-09-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2017-12-08 23:09:52" itemprop="dateModified" datetime="2017-12-08T23:09:52+08:00">2017-12-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/" itemprop="url" rel="index"><span itemprop="name">默认分类</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>参考：<br><a href="https://github.com/shadowsocks/shadowsocks/blob/master/README.md" target="_blank" rel="noopener">https://github.com/shadowsocks/shadowsocks/blob/master/README.md</a><br><strong>python版:</strong><br>安装配置比较简单<br>Debian / Ubuntu:</p>
<pre><code>apt-get install python-pip
pip install shadowsocks</code></pre><p><strong>参数说明：</strong><br><strong>-p 端口号</strong><br><strong>-k 密码</strong><br><strong>-m 加密方式</strong></p>
<p>前台运行:</p>
<pre><code>ssserver -p 443 -k password -m rc4-md5</code></pre><p>如果要后台运行：</p>
<pre><code>sudo ssserver -p 443 -k password -m rc4-md5 --user nobody -d start</code></pre><p>如果要停止：</p>
<pre><code>sudo ssserver -d stop</code></pre><p>如果要检查日志：</p>
<pre><code>sudo less /var/log/shadowsocks.log</code></pre><p>用 -h 查看所有参数。也可以使用配置文件进行配置。</p>
<p>配置文件相关:</p>
<pre><code>https://github.com/shadowsocks/shadowsocks/wiki/Configuration-via-Config-File</code></pre><p>创建一个config配置文件  /etc/shadowsocks.json. Example:</p>
<pre><code>{
    &quot;server&quot;:&quot;my_server_ip&quot;,
    &quot;server_port&quot;:8388,
    &quot;local_address&quot;: &quot;127.0.0.1&quot;,
    &quot;local_port&quot;:1080,
    &quot;password&quot;:&quot;mypassword&quot;,
    &quot;timeout&quot;:300,
    &quot;method&quot;:&quot;aes-256-cfb&quot;,
    &quot;fast_open&quot;: false
}</code></pre><p>前台运行:</p>
<pre><code>ssserver -c /etc/shadowsocks.json</code></pre><p>后台运行:</p>
<pre><code>ssserver -c /etc/shadowsocks.json -d start
ssserver -c /etc/shadowsocks.json -d stop</code></pre><p>shadowsocks还有一个C语言编译版，叫shadowssocks-libev<br>编译完占用内存比python版小，兼容python版的运行命令和配置文件，安装配置复杂点.<br>参考: <a href="https://github.com/shadowsocks/shadowsocks/blob/master/README.md" target="_blank" rel="noopener">https://github.com/shadowsocks/shadowsocks/blob/master/README.md</a></p>
<p><strong>服务器优化:</strong></p>
<p>官方要给的优化参考: <a href="https://github.com/shadowsocks/shadowsocks/wiki/Optimizing-Shadowsocks" target="_blank" rel="noopener">https://github.com/shadowsocks/shadowsocks/wiki/Optimizing-Shadowsocks</a></p>
<p>Linux 4.9+ 内核可以启用Google BBR 拥塞算法来加速TCP<br>我们用的谷歌VM服务器默认内核已经是4.10了，可以直接使用BBR</p>
<p>开启:</p>
<pre><code>echo &quot;net.core.default_qdisc=fq&quot; &gt;&gt; /etc/sysctl.conf
echo &quot;net.ipv4.tcp_congestion_control=bbr&quot; &gt;&gt; /etc/sysctl.conf</code></pre><p>保存并生效:</p>
<pre><code>sysctl -p</code></pre><p>参考<br><a href="http://blog.csdn.net/dog250/article/details/52830576" target="_blank" rel="noopener">http://blog.csdn.net/dog250/article/details/52830576</a><br><a href="http://blog.leanote.com/post/quincyhuang/google-bbr" target="_blank" rel="noopener">http://blog.leanote.com/post/quincyhuang/google-bbr</a><br><a href="https://www.zhihu.com/question/53559433/answer/135903103" target="_blank" rel="noopener">https://www.zhihu.com/question/53559433/answer/135903103</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hiyoi.com/2017/08/19/2017-08-19-Google%E5%92%8CBing%E7%9A%84%E7%AB%99%E7%82%B9%E5%9C%B0%E5%9B%BE%E6%8F%90%E4%BA%A4%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hiyoi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hiyoi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/08/19/2017-08-19-Google%E5%92%8CBing%E7%9A%84%E7%AB%99%E7%82%B9%E5%9C%B0%E5%9B%BE%E6%8F%90%E4%BA%A4%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">Google和Bing的站点地图提交方法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-08-19 23:02:00" itemprop="dateCreated datePublished" datetime="2017-08-19T23:02:00+08:00">2017-08-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2017-12-08 23:17:47" itemprop="dateModified" datetime="2017-12-08T23:17:47+08:00">2017-12-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/" itemprop="url" rel="index"><span itemprop="name">默认分类</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>再做网站SEO的时候，通常要提交<a href="http://ziyuan.baidu.com/wiki/640" target="_blank" rel="noopener">sitemap</a>文件<br>百度可以再百度站长后台直接提交，<br>Google和bing也都有自家平台的提交方法，<br>不过也有快捷的方法，比如：</p>
<p>Google:<br><code>http://www.google.com/webmasters/tools/ping?sitemap={url}</code><br>Bing:<br><code>http://www.bing.com/webmaster/ping.aspx?siteMap={url}</code></p>
<p>将{url}替换成站点sitemap的地址然后再浏览器中访问就可以了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hiyoi.com/2017/07/20/2017-07-20-js%E6%AD%A3%E5%88%99%E4%B8%80%E4%BA%9B%E5%9D%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hiyoi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hiyoi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/20/2017-07-20-js%E6%AD%A3%E5%88%99%E4%B8%80%E4%BA%9B%E5%9D%91/" class="post-title-link" itemprop="url">js正则一些坑</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-20 13:12:00" itemprop="dateCreated datePublished" datetime="2017-07-20T13:12:00+08:00">2017-07-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2017-12-08 23:15:29" itemprop="dateModified" datetime="2017-12-08T23:15:29+08:00">2017-12-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/" itemprop="url" rel="index"><span itemprop="name">默认分类</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>使用正则表达式字面量和使用 RegExp 构造函数创建的正则表达式不一样。在 ECMAScript 3 中, 正则表达式字面量始终会共享同一个RegExp实例,而使用构造函数创建的每一个新RegExp实例都是一个新实例。来看下面的例子。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var re = null,</span><br><span class="line">  i;</span><br><span class="line">for (i=0; i &lt; 10; i++)&#123;</span><br><span class="line">  re = /cat/g;</span><br><span class="line">  console.log( re.test(&quot;catastrophe&quot;));</span><br><span class="line">&#125;</span><br><span class="line">for (i=0; i &lt; 10; i++)&#123;</span><br><span class="line">  re = new RegExp(&quot;cat&quot;, &quot;g&quot;);</span><br><span class="line">   console.log( re.test(&quot;catastrophe&quot;));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在第一个循环中,即使是循环体中指定的,但实际上只为 /cat/ 创建了一个 RegExp 实例。由于实例属性不会重置,所以在循环中再次调用 test() 方法会失败。这是因为第一次调用 test() 找到了”cat”,但第二次调用是从索引为 3 的字符(上一次匹配的末尾)开始的,所以就找不到它了。由于会测试到字符串末尾,所以下一次再调用 test()就又从开头开始了。<br>第二个循环使用 RegExp 构造函数在每次循环中创建正则表达式。因为每次迭代都会创建一个新的 RegExp 实例,所以每次调用 test()都会返回 true。</p>
<ul>
<li>如果采用正则对象方式，RegExg接收的是字符串，\反斜杠是转义字符，\d会变成d，此时需要使用两个反斜杠，即\d来达到\d效果；但是在字面量方式中，不是字符串，所以使用一个反斜杠即可。</li>
<li>正则对象方式，可以接收参数，而正则字面量方式不可以。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hiyoi.com/2017/06/23/2017-06-23-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F-%E5%8C%B9%E9%85%8D%E9%87%8D%E5%A4%8D%E6%95%B0%E5%AD%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hiyoi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hiyoi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/06/23/2017-06-23-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F-%E5%8C%B9%E9%85%8D%E9%87%8D%E5%A4%8D%E6%95%B0%E5%AD%97/" class="post-title-link" itemprop="url">正则表达式-匹配重复数字</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-06-23 16:50:00" itemprop="dateCreated datePublished" datetime="2017-06-23T16:50:00+08:00">2017-06-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2017-12-14 17:14:20" itemprop="dateModified" datetime="2017-12-14T17:14:20+08:00">2017-12-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/" itemprop="url" rel="index"><span itemprop="name">默认分类</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>匹配重复数字 如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">111111</span><br><span class="line">222222</span><br><span class="line">333333333</span><br></pre></td></tr></table></figure>

<p>可以使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^(\d)\1&#123;5&#125;$</span><br></pre></td></tr></table></figure>

<p>(\d)  匹配一位数字<br>\1    匹配分组1中的内容，即(\d)<br>{5}   匹配\1五次</p>
<p>匹配AABB数字，如 1122</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^(\d)\1&#123;1&#125;(\d)\2&#123;1&#125;$</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">hiyoi</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hiyoi</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://hiyoi.com/',]
      });
      });
  </script>

</body>
</html>
